{# templates/admin/events/quick_events.html #}
{% extends "admin/base_site.html" %}
{% load static %}

{% block extrastyle %}
  {% include "includes/admin_quick_head.html" %}
  <style>
    /* ========= Fixes admin pour mobile (ANTI-OVERFLOW + SIDEBAR) ========= */
    @media (max-width: 1024px){
      .main-sidebar{ display:none !important; }
      .content-wrapper, .main-header, .main-footer{ margin-left:0 !important; }
      html, body{ overflow-x:hidden; }
      body.sidebar-open .content-wrapper,
      body.sidebar-open .main-header,
      body.sidebar-open .main-footer{ margin-left:0 !important; }
      .sidebar-overlay, .control-sidebar, .control-sidebar-dark{ display:none !important; }
      #container, .container, #content, .content, .breadcrumbs,
      .content-wrapper, .content-header{ min-width:0 !important; width:100% !important; }
      .aq-tabs, .aq-toolbar, .object-tools, .page-tools{ display:flex; flex-wrap:wrap; gap:8px; }
      .aq-tabs > a, .aq-toolbar > a{ flex:1 1 160px; min-width:0; }
    }

    /* ========= Design tokens ========= */
    :root{
      --bg:#f7f8fb; --panel:#ffffff; --text:#0f172a; --muted:#6b7280; --line:#e5e7eb;
      --brand:#2563eb; --brand-2:#1d4ed8; --ok:#16a34a; --warn:#f59e0b; --err:#dc2626;
      --radius:12px; --shadow:0 6px 22px rgba(10,22,70,.08); --shadow-sm:0 3px 12px rgba(10,22,70,.06);
    }

    /* ========= Layout base ========= */
    *{ box-sizing:border-box }
    body{ background:linear-gradient(180deg,#fbfdff,#f6f8fc 40%,#f4f6fb); }
    .aq-container{ max-width:1100px; margin-inline:auto; padding-inline:clamp(12px,3.2vw,18px); width:100% }
    .aq-container *{ min-width:0 }

    /* Messages Django */
    .messagelist{list-style:none;padding:0;margin:0 0 16px}
    .messagelist li{
      background:var(--panel); border:1px solid var(--line); border-left:4px solid var(--brand);
      color:var(--text); padding:12px 14px; border-radius:10px; box-shadow:var(--shadow-sm); margin-bottom:8px;
    }
    .messagelist .success{ border-left-color:var(--ok) } .messagelist .error{ border-left-color:var(--err) }
    .messagelist .warning{ border-left-color:var(--warn) }

    /* Cartes / sections */
    .card{ background:var(--panel); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow) }
    .card .card-body{ padding:clamp(14px,2.6vw,18px) }
    hr{ border-color:var(--line); margin:22px 0 }

    /* Inputs */
    .form-select,.form-control, textarea, select, input[type="text"], input[type="number"]{
      background:#fff; border:1px solid var(--line); color:var(--text); border-radius:10px; padding:10px 12px;
      outline:none; width:100%; transition:border .15s, box-shadow .15s, background .15s;
      max-width:100%;
    }
    .form-select:focus,.form-control:focus, textarea:focus, select:focus, input:focus{
      border-color:var(--brand); box-shadow:0 0 0 3px rgba(37,99,235,.18);
    }
    textarea{ min-height:220px; resize:vertical }

    /* >>> Empêche le <select> de créer du scroll horizontal et coupe le texte proprement */
    #matchSelect{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    @media (max-width: 520px){ #matchSelect{ font-size:13px; } }

    .aq-label{ color:var(--text); font-weight:700; margin-bottom:6px }
    .aq-hint{ color:var(--muted); font-size:12px; margin-top:6px }
    #teamsHint .pill{ background:#f1f5ff; color:#1e3a8a; border:1px solid #dbe6ff }
    .pill{ display:inline-block; padding:3px 10px; border-radius:999px; font-size:12px; border:1px solid var(--line); background:#f8fafc }

    /* ========= Grids / inline rows ========= */
    .aq-grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:18px }
    .aq-inline{
      display:grid; gap:10px; align-items:center; margin:10px 0 12px;
      grid-template-columns:1.2fr .8fr 1.2fr .7fr .6fr;
    }

    /* ========= Boutons ========= */
    .button{
      background:#fff; color:#0f172a; border:1px solid var(--line); border-radius:10px; padding:10px 14px;
      font-weight:600; cursor:pointer; transition:transform .08s ease, border .15s, background .2s, color .2s;
    }
    .button:hover{ border-color:#cdd5df; background:#f9fafb }
    .button:active{ transform:translateY(1px) }
    .button.default{
      background:linear-gradient(180deg,var(--brand),var(--brand-2)); color:#fff; border:none;
      box-shadow:0 6px 18px rgba(37,99,235,.25);
    }
    .button.default:hover{ filter:brightness(1.05) saturate(1.05) }

    .submit-row{ margin-top:8px; display:flex; gap:10px; flex-wrap:wrap }
    .submit-row .button{ min-width:180px }

    .aq-headline{ color:#0f172a; font-weight:800; letter-spacing:.2px; margin:20px 0 6px }
    .help{ color:var(--muted); margin:-4px 0 16px }

    /* ========= Tables éditables + conteneur responsive ========= */
    .table-wrap{
      position:relative; border-radius:var(--radius); border:1px solid var(--line);
      background:var(--panel); box-shadow:var(--shadow); overflow:hidden;
    }
    .table-scroll{ overflow-x:auto; -webkit-overflow-scrolling:touch; scroll-snap-type:x mandatory }
    .table-gradient-left,.table-gradient-right{
      content:""; position:absolute; top:0; bottom:0; width:24px; pointer-events:none; transition:opacity .2s; opacity:0;
    }
    .table-gradient-left{ left:0; background:linear-gradient(90deg,rgba(255,255,255,.95),rgba(255,255,255,0)) }
    .table-gradient-right{ right:0; background:linear-gradient(270deg,rgba(255,255,255,.95),rgba(255,255,255,0)) }
    .table-wrap.is-overflow .table-gradient-right{ opacity:1 }
    .table-wrap.is-scrolled .table-gradient-left{ opacity:1 }

    .grp-table{ width:100%; min-width:780px; border-collapse:separate; border-spacing:0 }
    .grp-table thead th{
      background:linear-gradient(180deg,#f8fbff,#f3f7ff); color:#0f172a; font-weight:700;
      padding:12px 10px; position:sticky; top:0; z-index:1; border-bottom:1px solid var(--line);
    }
    .grp-table td{ padding:10px 10px; border-top:1px solid var(--line); color:var(--text) }
    .grp-table tr:nth-child(even){ background:#fbfdff }
    .grp-table tr:hover{ background:#f5f9ff }
    .grp-table input.vTextField, .grp-table select.vTextField{ max-width:230px }

    .mini-photo img{ width:30px; height:30px; border-radius:50%; object-fit:cover; border:1px solid var(--line) }

    /* ========= Responsive tweaks ========= */
    @media (max-width: 980px){
      .aq-grid-2{ grid-template-columns:1fr; }
      textarea{ min-height:190px }
    }
    @media (max-width: 760px){
      .aq-inline{ grid-template-columns:1fr 1fr }
      .aq-inline .button{ grid-column:1/-1 }
      .card .card-body{ padding:14px }
      .messagelist li{ padding:10px 12px }
    }
    @media (max-width: 520px){
      .submit-row{ gap:8px }
      .submit-row .button{ min-width:unset; width:100% }
      textarea{ min-height:160px }
    }
  </style>
{% endblock %}

{% block content %}
<div class="aq-container">

  {% include "includes/admin_quick_toolbar.html" with active="events" title="Événements rapides (buts & cartons)" %}

  {% if messages %}
    <ul class="messagelist">
      {% for m in messages %}
        <li class="{{ m.tags }}">{{ m }}</li>
      {% endfor %}
    </ul>
  {% endif %}

  <form method="post" action="{% url 'admin_quick_events' %}" class="aq-form vstack" style="gap:16px; max-width:1000px;">
    {% csrf_token %}

    <!-- Match -->
    <div class="card">
      <div class="card-body">
        <label class="aq-label"><strong>Match</strong></label>
        <select id="matchSelect" name="match_id" required class="form-select">
          <option value="">-- Sélectionne un match --</option>
          {% for m in matches %}
            <option
              value="{{ m.id }}"
              data-home-id="{{ m.home_club.id }}"
              data-away-id="{{ m.away_club.id }}"
              data-home-name="{{ m.home_club.name }}"
              data-away-name="{{ m.away_club.name }}"
              title="#{{ m.id }} — {% if m.round %}{{ m.round.name }}{% else %}-{% endif %} — {{ m.home_club.name }} vs {{ m.away_club.name }} ({{ m.datetime|date:'Y-m-d H:i' }}) [{{ m.status }} {% if m.minute %}{{ m.minute }}'{% else %}0'{% endif %}]"
            >
              #{{ m.id }} — {% if m.round %}{{ m.round.name }}{% else %}-{% endif %} — {{ m.home_club.name }} vs {{ m.away_club.name }}
              ({{ m.datetime|date:"Y-m-d H:i" }}) [{{ m.status }} {% if m.minute %}{{ m.minute }}'{% else %}0'{% endif %}]
            </option>
          {% endfor %}
        </select>
        <div id="teamsHint" class="aq-hint" style="margin-top:6px;"></div>
      </div>
    </div>

    <!-- Club -->
    <div class="card">
      <div class="card-body">
        <label class="aq-label"><strong>Club concerné</strong> (équipe qui marque / reçoit le carton)</label>
        <select id="clubSelect" name="club_id" required class="form-select">
          <option value="">-- Sélectionne un club --</option>
          {% for c in clubs %}
            <option value="{{ c.id }}">{{ c.name }}</option>
          {% endfor %}
        </select>
        <div class="aq-hint">Une fois le club choisi, la liste des joueurs ci-dessous se remplit.</div>
      </div>
    </div>

    <!-- Grille 2 colonnes -->
    <div class="aq-grid-2">
      <!-- BUTS -->
      <div class="card">
        <div class="card-body">
          <div class="aq-section-head">
            <label class="aq-label"><strong>Buts</strong> (1 ligne = 1 but)</label>
          </div>

          <div class="aq-inline">
            <select id="goalPlayerSelect" class="form-select" disabled>
              <option value="">— Buteur —</option>
            </select>
            <input id="goalMinute" class="form-control" placeholder="Minute (ex: 12 ou 90+2)" />
            <select id="assistSelect" class="form-select" disabled>
              <option value="">— Passeur (optionnel) —</option>
            </select>
            <select id="goalType" class="form-select">
              <option value="">Type</option>
              <option value="pen">pen</option>
              <option value="csc">csc</option>
            </select>
            <button type="button" class="button" id="btnAppendGoal">Ajouter</button>
          </div>

          <textarea id="goalsText" name="goals_text" rows="12" placeholder=""></textarea>
        </div>
      </div>

      <!-- CARTONS -->
      <div class="card">
        <div class="card-body">
          <div class="aq-section-head">
            <label class="aq-label"><strong>Cartons</strong> (1 ligne = 1 carton)</label>
          </div>

          <div class="aq-inline">
            <select id="cardPlayerSelect" class="form-select" disabled>
              <option value="">— Joueur —</option>
            </select>
            <input id="cardMinute" class="form-control" placeholder="Minute (ex: 17 ou 45+2)" />
            <select id="cardColor" class="form-select">
              <option value="Y">Jaune</option>
              <option value="R">Rouge</option>
            </select>
            <button type="button" class="button" id="btnAppendCard">Ajouter</button>
          </div>

          <textarea id="cardsText" name="cards_text" rows="12" placeholder=""></textarea>
        </div>
      </div>
    </div>

    <!-- Submit -->
    <div class="submit-row">
      <input type="submit" value="Enregistrer" class="button default">
    </div>
  </form>

  <hr/>

  <h2 class="aq-headline">Éditer les événements du match</h2>
  <p class="help">Choisis un match ci-dessus : la liste s’affiche ci-dessous. Tu peux modifier minute, joueur, passeur, couleur — <strong>cocher Pen./CSC</strong> — et téléverser une photo pour le joueur.</p>

  <div id="eventsWrap" style="display:none; gap:16px;">
    <div style="flex:1;">
      <h3 class="aq-label" style="margin-bottom:10px;">Buts</h3>
      <div class="table-wrap" data-wrap="goals">
        <div class="table-gradient-left"></div>
        <div class="table-scroll">
          <table class="grp-table" id="goalsTable">
            <thead><tr>
              <th>#</th><th>Club</th><th>Minute</th><th>Joueur</th><th>Passeur</th><th>Type</th><th>Photo</th><th>Actions</th>
            </tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="table-gradient-right"></div>
      </div>
    </div>

    <div style="flex:1; margin-top:24px;">
      <h3 class="aq-label" style="margin-bottom:10px;">Cartons</h3>
      <div class="table-wrap" data-wrap="cards">
        <div class="table-gradient-left"></div>
        <div class="table-scroll">
          <table class="grp-table" id="cardsTable">
            <thead><tr>
              <th>#</th><th>Club</th><th>Minute</th><th>Joueur</th><th>Couleur</th><th>Photo</th><th>Actions</th>
            </tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="table-gradient-right"></div>
      </div>
    </div>
  </div>

  <script>
  (function() {
    function collapseSidebarForMobile(){
      if (window.innerWidth <= 1024){
        document.body.classList.add('sidebar-collapse');
        document.body.classList.remove('sidebar-open');
      }
    }
    collapseSidebarForMobile();
    window.addEventListener('resize', collapseSidebarForMobile);

    const matchSelect = document.getElementById('matchSelect');
    const clubSelect  = document.getElementById('clubSelect');
    const teamsHint   = document.getElementById('teamsHint');

    const goalsTbody = document.querySelector("#goalsTable tbody");
    const cardsTbody = document.querySelector("#cardsTable tbody");
    const wrap = document.getElementById("eventsWrap");

    const csrf = document.querySelector('[name=csrfmiddlewaretoken]').value;

    const goalPlayerSelect = document.getElementById('goalPlayerSelect');
    const assistSelect     = document.getElementById('assistSelect');
    const goalMinuteInput  = document.getElementById('goalMinute');
    const goalTypeSelect   = document.getElementById('goalType');
    const btnAppendGoal    = document.getElementById('btnAppendGoal');

    const cardPlayerSelect = document.getElementById('cardPlayerSelect');
    const cardMinuteInput  = document.getElementById('cardMinute');   /* <-- FIX ici */
    const cardColorSelect  = document.getElementById('cardColor');
    const btnAppendCard    = document.getElementById('btnAppendCard');

    const goalsText  = document.getElementById('goalsText');
    const cardsText  = document.getElementById('cardsText');

    function appendLine(textarea, line) {
      if (!line) return;
      if (textarea.value && !textarea.value.endsWith('\n')) textarea.value += '\n';
      textarea.value += line;
      textarea.focus();
    }
    function opt(value, label){
      const o = document.createElement('option'); o.value=value; o.textContent=label; return o;
    }
    function fullName(p){
      if (p.name && p.name.trim()) return p.name;
      const a = (p.first_name||'').trim(), b = (p.last_name||'').trim();
      return (a + ' ' + b).trim() || ('Joueur #' + p.id);
    }
    function decorate(p){
      const nm = fullName(p);
      return (p.number!=null && p.number!=='') ? `#${p.number} — ${nm}` : nm;
    }
    async function fetchJSON(url){
      try{ const r = await fetch(url); return await r.json(); }catch{ return []; }
    }

    async function loadClubPlayers(clubId){
      goalPlayerSelect.innerHTML = ''; assistSelect.innerHTML = ''; cardPlayerSelect.innerHTML = '';
      goalPlayerSelect.appendChild(opt('', '— Buteur —'));
      assistSelect.appendChild(opt('', '— Passeur (optionnel) —'));
      cardPlayerSelect.appendChild(opt('', '— Joueur —'));
      goalPlayerSelect.disabled = assistSelect.disabled = cardPlayerSelect.disabled = true;
      if(!clubId) return;

      const data = await fetchJSON(`/api/players/?club=${encodeURIComponent(clubId)}&page_size=500`);
      const arr  = Array.isArray(data) ? data : (data.results || []);
      arr.sort((a,b)=>{
        const na = (a.number==null? 9999 : a.number), nb = (b.number==null? 9999 : b.number);
        if (na !== nb) return na - nb;
        return fullName(a).localeCompare(fullName(b));
      });
      for (const p of arr){
        const label = decorate(p);
        const value = fullName(p);
        goalPlayerSelect.appendChild(opt(value, label));
        assistSelect.appendChild(opt(value, label));
        cardPlayerSelect.appendChild(opt(value, label));
      }
      goalPlayerSelect.disabled = assistSelect.disabled = cardPlayerSelect.disabled = false;
    }

    const allClubOptions = Array.from(clubSelect.querySelectorAll('option')).map(opt => ({ value: opt.value, text: opt.textContent }));

    function setClubOptions(homeId, awayId, homeName, awayName) {
      clubSelect.innerHTML = '';
      clubSelect.appendChild(opt('', '-- Sélectionne un club --'));
      clubSelect.appendChild(opt(homeId, homeName + ' (Home)'));
      clubSelect.appendChild(opt(awayId, awayName + ' (Away)'));
      teamsHint.innerHTML = '<span class="pill">Home: ' + homeName + '</span> ' + '<span class="pill">Away: ' + awayName + '</span>';
      loadClubPlayers('');
    }

    function onMatchChange() {
      const optEl = matchSelect.options[matchSelect.selectedIndex];
      if (!optEl || !optEl.dataset.homeId || !optEl.dataset.awayId) {
        clubSelect.innerHTML = '';
        clubSelect.appendChild(opt('', '-- Sélectionne un club --'));
        allClubOptions.forEach(o => clubSelect.appendChild(opt(o.value, o.text)));
        teamsHint.textContent = '';
        wrap.style.display = "none";
        goalsTbody.innerHTML = "";
        cardsTbody.innerHTML = "";
        loadClubPlayers('');
        return;
      }
      setClubOptions(optEl.dataset.homeId, optEl.dataset.awayId, optEl.dataset.homeName, optEl.dataset.awayName);
      loadList();
    }

    const LS_MATCH_KEY = 'quick_events_match';
    const LS_CLUB_KEY  = 'quick_events_club';

    function saveSelection(){
      localStorage.setItem(LS_MATCH_KEY, matchSelect.value || '');
      localStorage.setItem(LS_CLUB_KEY,  clubSelect.value  || '');
    }

    function restoreSelection(){
      const mid = localStorage.getItem(LS_MATCH_KEY) || '';
      if (mid) {
        const opt = Array.from(matchSelect.options).find(o => o.value === mid);
        if (opt) { matchSelect.value = mid; onMatchChange(); }
      }
      const cid = localStorage.getItem(LS_CLUB_KEY) || '';
      if (cid) {
        const applyClub = () => {
          const has = Array.from(clubSelect.options).some(o => o.value === cid);
          if (has) { clubSelect.value = cid; loadClubPlayers(cid); }
        };
        setTimeout(applyClub, 0);
      }
    }

    matchSelect.addEventListener('change', ()=>{ onMatchChange(); saveSelection(); });
    clubSelect.addEventListener('change', ()=>{ loadClubPlayers(clubSelect.value || ''); saveSelection(); });

    btnAppendGoal.addEventListener('click', ()=>{
      const who = (goalPlayerSelect.value || '').trim();
      if(!who){ alert('Choisis un buteur'); return; }
      const minute = (goalMinuteInput.value || '0').trim();
      const assist = (assistSelect.value || '').trim();
      const tag    = (goalTypeSelect.value || '').trim();
      const suffix = tag ? (' ' + tag) : '';
      const line = assist ? `${who} ${minute} (${assist})${suffix}` : `${who} ${minute}${suffix}`;
      appendLine(goalsText, line);
      goalMinuteInput.value = ''; goalTypeSelect.value = '';
    });

    btnAppendCard.addEventListener('click', ()=>{
      const who = (cardPlayerSelect.value || '').trim();
      if(!who){ alert('Choisis un joueur'); return; }
      const minute = (cardMinuteInput.value || '0').trim();
      const color  = (cardColorSelect.value || 'Y').trim();
      const line = `${who} ${minute} ${color}`;
      appendLine(cardsText, line);
      cardMinuteInput.value = '';
    });

    async function api(action, payload, isMultipart){
      const url = "{% url 'admin_quick_events_api' %}";
      if(isMultipart){
        payload.append("action", action);
        const res = await fetch(url, { method:"POST", body: payload, headers: {"X-CSRFToken": csrf } });
        return await res.json();
      }
      const body = new URLSearchParams({action, ...payload});
      const res = await fetch(url, {
        method:"POST",
        headers: {"X-CSRFToken": csrf, "Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"},
        body
      });
      return await res.json();
    }

    function badgePhoto(src){
      const url = src || "/static/admin/img/icon-unknown.svg";
      return `<img src="${url}" style="width:28px;height:28px;border-radius:50%;object-fit:cover;border:1px solid #e5e7eb" onerror="this.src='/static/admin/img/icon-unknown.svg'"/>`;
    }

    function rowGoal(i, g){
      const pen = g.is_penalty ? 'checked' : '';
      const og  = g.is_own_goal ? 'checked' : '';
      return `<tr data-id="${g.id}">
        <td>${i}</td>
        <td>${g.club_name}</td>
        <td><input type="number" min="0" value="${g.minute||0}" class="vTextField" style="width:80px" data-f="minute"/></td>
        <td><input type="text" value="${g.player_name||""}" class="vTextField" style="width:200px" placeholder="#9, id:42 ou Nom" data-f="player_token"/></td>
        <td><input type="text" value="${g.assist_name||""}" class="vTextField" style="width:180px" placeholder="#10, id:77 ou Nom" data-f="assist_token"/></td>
        <td>
          <label style="margin-right:8px;"><input type="checkbox" data-f="is_penalty" ${pen}/> Pen.</label>
          <label><input type="checkbox" data-f="is_own_goal" ${og}/> CSC</label>
        </td>
        <td>
          <label class="button" style="margin:0;">Choisir
            <input type="file" accept="image/*" style="display:none" data-player="${g.player_id||''}" data-kind="goal"/>
          </label>
          <span class="mini-photo">${badgePhoto(g.player_photo)}</span>
        </td>
        <td>
          <button class="button default" data-action="save-goal">Enregistrer</button>
          <button class="button" data-action="del-goal">Supprimer</button>
        </td>
      </tr>`;
    }

    function rowCard(i, c){
      const color = (c.color||"").toString().toUpperCase();
      const optHtml = (v,l)=>`<option value="${v}" ${color===v?'selected':''}>${l}</option>`;
      return `<tr data-id="${c.id}">
        <td>${i}</td>
        <td>${c.club_name}</td>
        <td><input type="number" min="0" value="${c.minute||0}" class="vTextField" style="width:80px" data-f="minute"/></td>
        <td><input type="text" value="${c.player_name||""}" class="vTextField" style="width:200px" placeholder="#4, id:12 ou Nom" data-f="player_token"/></td>
        <td>
          <select class="vTextField" data-f="color" style="width:120px">
            ${optHtml('Y','Jaune')} ${optHtml('R','Rouge')}
          </select>
        </td>
        <td>
          <label class="button" style="margin:0;">Choisir
            <input type="file" accept="image/*" style="display:none" data-player="${c.player_id||''}" data-kind="card"/>
          </label>
          <span class="mini-photo">${badgePhoto(c.player_photo)}</span>
        </td>
        <td>
          <button class="button default" data-action="save-card">Enregistrer</button>
          <button class="button" data-action="del-card">Supprimer</button>
        </td>
      </tr>`;
    }

    async function loadList(){
      const mid = matchSelect.value;
      if(!mid){ wrap.style.display="none"; goalsTbody.innerHTML=""; cardsTbody.innerHTML=""; return; }
      const url = "{% url 'admin_quick_events_api' %}" + `?action=list&match_id=${mid}`;
      const res = await fetch(url);
      const data = await res.json();
      goalsTbody.innerHTML = (data.goals||[]).map((g,i)=>rowGoal(i+1,g)).join("");
      cardsTbody.innerHTML = (data.cards||[]).map((c,i)=>rowCard(i+1,c)).join("");
      wrap.style.display = "block";
      refreshScrollGradients();
    }

    function refreshOneWrap(w){
      const sc = w.querySelector('.table-scroll'); if(!sc) return;
      const maxScroll = sc.scrollWidth - sc.clientWidth;
      if (maxScroll > 0) w.classList.add('is-overflow'); else w.classList.remove('is-overflow');
      if (sc.scrollLeft > 2) w.classList.add('is-scrolled'); else w.classList.remove('is-scrolled');
    }
    function refreshScrollGradients(){ document.querySelectorAll('.table-wrap').forEach(refreshOneWrap); }
    document.addEventListener('scroll', refreshScrollGradients, true);
    window.addEventListener('resize', refreshScrollGradients);

    document.addEventListener("click", async (e)=>{
      const btn = e.target.closest("button"); if(!btn) return;
      const tr = e.target.closest("tr");

      if(btn.dataset.action==="save-goal"){
        const payload = {
          id: tr.dataset.id,
          minute: tr.querySelector('[data-f="minute"]').value,
          player_token: tr.querySelector('[data-f="player_token"]').value,
          assist_token: tr.querySelector('[data-f="assist_token"]').value,
          is_penalty: tr.querySelector('[data-f="is_penalty"]').checked ? "1" : "0",
          is_own_goal: tr.querySelector('[data-f="is_own_goal"]').checked ? "1" : "0",
        };
        const r = await api("update_goal", payload);
        if(r.ok){ await loadList(); }
      }

      if(btn.dataset.action==="del-goal"){
        if(confirm("Supprimer ce but ?")){
          const r = await api("delete_goal", {id: tr.dataset.id});
          if(r.ok){ tr.remove(); refreshScrollGradients(); }
        }
      }

      if(btn.dataset.action==="save-card"){
        const payload = {
          id: tr.dataset.id,
          minute: tr.querySelector('[data-f="minute"]').value,
          player_token: tr.querySelector('[data-f="player_token"]').value,
          color: tr.querySelector('[data-f="color"]').value,
        };
        const r = await api("update_card", payload);
        if(r.ok){ await loadList(); }
      }

      if(btn.dataset.action==="del-card"){
        if(confirm("Supprimer ce carton ?")){
          const r = await api("delete_card", {id: tr.dataset.id});
          if(r.ok){ tr.remove(); refreshScrollGradients(); }
        }
      }
    });

    document.addEventListener("change", async (e)=>{
      const input = e.target;
      if(input.type==="file" && input.dataset.player){
        const pid = input.dataset.player;
        if(!pid){ alert("Aucun joueur lié à cette ligne."); input.value=""; return; }
        const fd = new FormData();
        fd.append("player_id", pid);
        fd.append("photo", input.files[0]);
        const r = await api("upload_photo", fd, true);
        if(r.ok){
          const span = input.closest("td").querySelector(".mini-photo");
          span.innerHTML = `<img src="${r.photo}" style="width:28px;height:28px;border-radius:50%;object-fit:cover;border:1px solid #e5e7eb"/>`;
        }
        input.value="";
      }
    });

    restoreSelection();
  })();
  </script>

</div>
{% endblock %}
